<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCNB Social | ULTRA ALL-IN-ONE</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style id="custom-theme">
        :root { 
            --main: #00a884; --bg: #111b21; --panel: #202c33; --sidebar-dark: #182229; --text: #e9edef; 
            --msg-out: #005c4b; --msg-in: #202c33; --font-size: 14px; --radius: 10px;
            --chat-bg: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
        }
    </style>
    <style>
        body, html { height: 100%; margin: 0; font-family: 'Segoe UI', sans-serif; background: #0c1317; color: var(--text); overflow: hidden; font-size: var(--font-size); }
        #main-app { display: none; height: 100vh; grid-template-columns: 60px 350px 1fr; }
        
        /* ЛЕВАЯ ПАНЕЛЬ */
        .nav-rail { background: var(--sidebar-dark); display: flex; flex-direction: column; align-items: center; padding: 20px 0; gap: 25px; border-right: 1px solid #313d45; }
        .nav-item { color: #8696a0; font-size: 22px; cursor: pointer; transition: 0.3s; width: 100%; text-align: center; padding: 10px 0; }
        .nav-item:hover, .nav-item.active { color: var(--main); }
        
        /* САЙДБАР */
        .sidebar { background: var(--panel); display: flex; flex-direction: column; border-right: 1px solid #313d45; overflow: hidden; }
        .sidebar-header { padding: 15px; background: rgba(255,255,255,0.05); display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #313d45; }
        .sidebar-header img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--main); }
        .contact { display: flex; align-items: center; padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #222d34; transition: 0.2s; }
        .contact:hover { background: #2a3942; }
        .contact img { width: 45px; height: 45px; border-radius: 50%; margin-right: 15px; }

        /* КОНТЕНТ */
        .content-area { position: relative; height: 100%; }
        #chat-view { display: flex; flex-direction: column; height: 100%; }
        .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; background: var(--chat-bg); }
        .msg { max-width: 65%; padding: 10px 14px; border-radius: var(--radius); color: white; position: relative; }
        .msg.sent { align-self: flex-end; background: var(--msg-out); }
        .msg.received { align-self: flex-start; background: var(--msg-in); }

        /* ЗВОНОК */
        #call-overlay { display: none; position: absolute; inset: 0; background: #000; z-index: 1000; flex-direction: column; align-items: center; justify-content: center; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { width: 130px; height: 180px; position: absolute; bottom: 100px; right: 20px; border-radius: 12px; border: 2px solid var(--main); z-index: 1002; background: #222; }
        .call-ui { position: absolute; bottom: 30px; display: flex; gap: 15px; z-index: 1005; }
        .call-btn { width: 60px; height: 60px; border-radius: 50%; border: none; color: white; cursor: pointer; font-size: 22px; display: flex; align-items: center; justify-content: center; }

        /* ЛЕНТА И НАСТРОЙКИ */
        #feed-view, #settings-view { display: none; flex-direction: column; height: 100%; overflow-y: auto; padding: 20px; align-items: center; background: #0b141a; }
        .card { background: var(--panel); border-radius: var(--radius); width: 100%; max-width: 600px; padding: 20px; margin-bottom: 20px; border: 1px solid #313d45; }
        .btn-main { background: var(--main); color: white; border: none; padding: 12px 24px; border-radius: var(--radius); cursor: pointer; font-weight: bold; }
        input, textarea { background: #2a3942; border: 1px solid #313d45; padding: 12px; border-radius: var(--radius); color: white; outline: none; width: 100%; box-sizing: border-box; }
        
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: var(--bg); }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 style="color: var(--main); font-size: 70px; margin: 0;">RCNB</h1>
        <p style="color: #8696a0; margin-bottom: 30px;">Social Network & Messenger</p>
        <button class="btn-main" onclick="login()" style="font-size: 18px; border-radius: 30px;">Войти через Google</button>
    </div>

    <div id="main-app">
        <div class="nav-rail">
            <div class="nav-item active" id="n-chat" onclick="showView('chat')"><i class="fa fa-comment-dots"></i></div>
            <div class="nav-item" id="n-feed" onclick="showView('feed')"><i class="fa fa-newspaper"></i></div>
            <div class="nav-item" id="n-people" onclick="showView('all')"><i class="fa fa-users"></i></div>
            <div class="nav-item" id="n-set" onclick="showView('settings')"><i class="fa fa-sliders"></i></div>
            <div class="nav-item" onclick="logout()" style="margin-top: auto;"><i class="fa fa-sign-out-alt"></i></div>
        </div>

        <div class="sidebar">
            <div class="sidebar-header">
                <img id="my-pic" src="">
                <div style="overflow:hidden"><b id="my-name">...</b><div id="my-status" style="font-size:11px; color:#8696a0; white-space:nowrap; text-overflow:ellipsis;"></div></div>
            </div>
            <div id="sidebar-list" style="overflow-y:auto; flex:1"></div>
        </div>

        <div class="content-area">
            <div id="call-overlay">
                <video id="remote-video" autoplay playsinline></video>
                <video id="local-video" autoplay playsinline muted></video>
                <div id="call-meta" style="position:absolute; top:50px; text-align:center; width:100%">
                    <h2 id="call-status" style="color:white;">Вызов...</h2>
                    <h4 id="call-name" style="color:var(--main)"></h4>
                </div>
                <div class="call-ui">
                    <button id="btn-ans" class="call-btn" style="background:#25d366; display:none"><i class="fa fa-phone"></i></button>
                    <button onclick="hangUp()" class="call-btn" style="background:#ea4335"><i class="fa fa-phone-slash"></i></button>
                </div>
            </div>

            <div id="chat-view">
                <div style="padding:10px 20px; background:var(--panel); height:60px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #313d45;">
                    <b id="chat-target">Выберите чат</b>
                    <div id="chat-tools" style="display:none; gap:15px;">
                        <button onclick="makeCall(false)" style="background:none; border:none; color:var(--main); cursor:pointer; font-size:18px;"><i class="fa fa-phone"></i></button>
                        <button onclick="makeCall(true)" style="background:none; border:none; color:var(--main); cursor:pointer; font-size:18px;"><i class="fa fa-video"></i></button>
                    </div>
                </div>
                <div class="messages" id="messages"></div>
                <div style="padding:15px; background:var(--panel); display:flex; gap:10px;">
                    <input type="text" id="msg-input" placeholder="Сообщение..." onkeypress="if(event.key==='Enter') sendMsg()">
                    <button onclick="sendMsg()" class="btn-main"><i class="fa fa-paper-plane"></i></button>
                </div>
            </div>

            <div id="feed-view">
                <div class="card">
                    <textarea id="post-text" placeholder="Что нового?"></textarea>
                    <button class="btn-main" onclick="createPost()" style="width:100%; margin-top:10px;">Опубликовать</button>
                </div>
                <div id="feed-container" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
            </div>

            <div id="settings-view">
                <div class="card">
                    <h3>Профиль</h3>
                    <input type="text" id="set-name" placeholder="Никнейм" style="margin-bottom:10px">
                    <input type="text" id="set-stat" placeholder="Статус" style="margin-bottom:10px">
                    <button class="btn-main" onclick="saveProfile()">Обновить данные</button>
                </div>
                <div class="card">
                    <h3>Интерфейс</h3>
                    <div style="margin-bottom:15px"><label>Цвет темы:</label><input type="color" id="ui-color" onchange="updateUI()"></div>
                    <div style="margin-bottom:15px"><label>Размер текста:</label><input type="range" id="ui-font" min="12" max="20" oninput="updateUI()"></div>
                    <div style="margin-bottom:15px"><label>Скругление:</label><input type="range" id="ui-rad" min="0" max="30" oninput="updateUI()"></div>
                    <div style="margin-bottom:15px"><label>Фон чата (URL):</label><input type="text" id="ui-bg" onchange="updateUI()"></div>
                </div>
            </div>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDch7p3qsay4twoc3GcXI2Z7YI5iHazuHs",
        authDomain: "rcnb-messenger.firebaseapp.com",
        projectId: "rcnb-messenger",
        storageBucket: "rcnb-messenger.firebasestorage.app",
        messagingSenderId: "131047901393",
        appId: "1:131047901393:web:d6f5ae21a875b6aef75df0"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const provider = new firebase.auth.GoogleAuthProvider();

    let me = null, activeChat = null, pc = null, localStream = null;

    auth.onAuthStateChanged(user => {
        if (user) {
            me = user;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'grid';
            syncUser(user);
            showView('chat');
            listenCalls();
            loadSavedUI();
        } else {
            document.getElementById('login-screen').style.display = 'flex';
        }
    });

    function login() { auth.signInWithPopup(provider); }
    function logout() { auth.signOut(); }

    function syncUser(u) {
        db.collection("users").doc(u.uid).onSnapshot(doc => {
            const d = doc.data() || {};
            document.getElementById('my-pic').src = d.photo || u.photoURL;
            document.getElementById('my-name').innerText = d.name || u.displayName;
            document.getElementById('my-status').innerText = d.status || "В сети RCNB";
            if(!doc.exists) db.collection("users").doc(u.uid).set({name:u.displayName, photo:u.photoURL, uid:u.uid, status: ""});
        });
    }

    function showView(v) {
        const ids = ['chat-view', 'feed-view', 'settings-view'];
        ids.forEach(id => document.getElementById(id).style.display = id.startsWith(v) ? 'flex' : 'none');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('n-'+(v==='all'?'people':v.substring(0,3))).classList.add('active');
        if(v === 'feed') loadFeed();
        loadSidebar(v === 'all' ? 'all' : 'chats');
    }

    function loadSidebar(mode) {
        db.collection("users").onSnapshot(snap => {
            const list = document.getElementById('sidebar-list');
            list.innerHTML = "";
            snap.forEach(doc => {
                const u = doc.data();
                if(u.uid !== me.uid) {
                    list.innerHTML += `<div class="contact" onclick="openChat('${u.uid}', '${u.name}')">
                        <img src="${u.photo || ''}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/149/149071.png'">
                        <div><b>${u.name}</b><div style="font-size:11px;color:#8696a0">${u.status || ''}</div></div>
                    </div>`;
                }
            });
        });
    }

    function openChat(uid, name) {
        activeChat = uid;
        document.getElementById('chat-target').innerText = name;
        document.getElementById('chat-tools').style.display = 'flex';
        loadMsgs();
    }

    function sendMsg() {
        const i = document.getElementById('msg-input');
        if(!i.value || !activeChat) return;
        db.collection("chats").doc([me.uid, activeChat].sort().join('_')).collection("messages").add({
            text: i.value, sender: me.uid, time: firebase.firestore.FieldValue.serverTimestamp()
        });
        i.value = "";
    }

    function loadMsgs() {
        db.collection("chats").doc([me.uid, activeChat].sort().join('_')).collection("messages").orderBy("time").onSnapshot(snap => {
            const box = document.getElementById('messages');
            box.innerHTML = "";
            snap.forEach(doc => {
                const m = doc.data();
                box.innerHTML += `<div class="msg ${m.sender === me.uid ? 'sent' : 'received'}">${m.text}</div>`;
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    // ЛЕНТА
    async function createPost() {
        const t = document.getElementById('post-text');
        if(!t.value) return;
        const u = (await db.collection("users").doc(me.uid).get()).data();
        await db.collection("posts").add({
            text: t.value, author: u.name, pic: u.photo, likes: [], time: Date.now()
        });
        t.value = "";
    }

    function loadFeed() {
        db.collection("posts").orderBy("time", "desc").onSnapshot(snap => {
            const cont = document.getElementById('feed-container');
            cont.innerHTML = "";
            snap.forEach(doc => {
                const p = doc.data();
                const liked = p.likes.includes(me.uid);
                cont.innerHTML += `<div class="card">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px"><img src="${p.pic}" style="width:35px;border-radius:50%"><b>${p.author}</b></div>
                    <div>${p.text}</div>
                    <div style="margin-top:10px; cursor:pointer; color:${liked?'red':'white'}" onclick="like('${doc.id}', ${liked})">
                        <i class="fa-heart ${liked?'fas':'far'}"></i> ${p.likes.length}
                    </div>
                </div>`;
            });
        });
    }

    async function like(id, l) {
        const r = db.collection("posts").doc(id);
        r.update({ likes: l ? firebase.firestore.FieldValue.arrayRemove(me.uid) : firebase.firestore.FieldValue.arrayUnion(me.uid) });
    }

    // ЗВОНКИ
    async function getMedia(video) {
        const constraints = { audio: true, video: video };
        try {
            return await navigator.mediaDevices.getUserMedia(constraints);
        } catch(e) {
            alert("Камера/Микрофон недоступны. Убедитесь, что используете HTTPS или Localhost.");
            return null;
        }
    }

    async function makeCall(video) {
        document.getElementById('call-overlay').style.display = 'flex';
        localStream = await getMedia(video);
        if(!localStream) return hangUp();
        
        document.getElementById('local-video').srcObject = localStream;
        document.getElementById('local-video').style.display = video ? 'block' : 'none';

        pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
        pc.ontrack = e => document.getElementById('remote-video').srcObject = e.streams[0];

        const callDoc = db.collection('calls').doc(activeChat);
        pc.onicecandidate = e => e.candidate && callDoc.collection('offerCandidates').add(e.candidate.toJSON());

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await callDoc.set({ offer, caller: me.displayName, video });

        callDoc.onSnapshot(s => {
            const d = s.data();
            if(!pc.currentRemoteDescription && d?.answer) pc.setRemoteDescription(new RTCSessionDescription(d.answer));
        });

        callDoc.collection('answerCandidates').onSnapshot(s => {
            s.docChanges().forEach(c => c.type === 'added' && pc.addIceCandidate(new RTCIceCandidate(c.doc.data())));
        });
    }

    function listenCalls() {
        db.collection('calls').doc(me.uid).onSnapshot(async s => {
            const d = s.data();
            if(d && d.offer && !pc) {
                document.getElementById('call-overlay').style.display = 'flex';
                document.getElementById('call-status').innerText = "Входящий звонок...";
                document.getElementById('call-name').innerText = d.caller;
                document.getElementById('btn-ans').style.display = 'flex';
                document.getElementById('btn-ans').onclick = () => accept(d);
            }
            if(!d && pc) hangUp();
        });
    }

    async function accept(d) {
        document.getElementById('btn-ans').style.display = 'none';
        localStream = await getMedia(d.video);
        document.getElementById('local-video').srcObject = localStream;
        document.getElementById('local-video').style.display = d.video ? 'block' : 'none';

        pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
        pc.ontrack = e => document.getElementById('remote-video').srcObject = e.streams[0];

        const callDoc = db.collection('calls').doc(me.uid);
        pc.onicecandidate = e => e.candidate && callDoc.collection('answerCandidates').add(e.candidate.toJSON());

        await pc.setRemoteDescription(new RTCSessionDescription(d.offer));
        const ans = await pc.createAnswer();
        await pc.setLocalDescription(ans);
        await callDoc.update({ answer: ans });

        callDoc.collection('offerCandidates').onSnapshot(s => {
            s.docChanges().forEach(c => c.type === 'added' && pc.addIceCandidate(new RTCIceCandidate(c.doc.data())));
        });
    }

    function hangUp() {
        if(pc) pc.close();
        if(localStream) localStream.getTracks().forEach(t => t.stop());
        pc = null; localStream = null;
        db.collection('calls').doc(me.uid).delete();
        if(activeChat) db.collection('calls').doc(activeChat).delete();
        document.getElementById('call-overlay').style.display = 'none';
    }

    // ИНТЕРФЕЙС
    function updateUI() {
        const c = document.getElementById('ui-color').value;
        const f = document.getElementById('ui-font').value;
        const r = document.getElementById('ui-rad').value;
        const b = document.getElementById('ui-bg').value;
        const style = `:root { --main: ${c}; --font-size: ${f}px; --radius: ${r}px; --msg-out: ${c}; --chat-bg: url('${b||'https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'}'); }`;
        document.getElementById('custom-theme').innerHTML = style;
        localStorage.setItem('rcnb_ui', JSON.stringify({c, f, r, b}));
    }

    function loadSavedUI() {
        const s = JSON.parse(localStorage.getItem('rcnb_ui'));
        if(s) {
            document.getElementById('ui-color').value = s.c;
            document.getElementById('ui-font').value = s.f;
            document.getElementById('ui-rad').value = s.r;
            document.getElementById('ui-bg').value = s.b;
            updateUI();
        }
    }

    async function saveProfile() {
        await db.collection("users").doc(me.uid).update({
            name: document.getElementById('set-name').value,
            status: document.getElementById('set-stat').value
        });
        alert("Данные сохранены!");
    }
</script>
</body>
</html>
